<?xml version="1.0" encoding="UTF-8"?>
<ctl:package xmlns="http://www.occamlab.com/ctl"
 xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
 xmlns:ctl="http://www.occamlab.com/ctl"
 xmlns:parsers="http://www.occamlab.com/te/parsers"
 xmlns:p="http://teamengine.sourceforge.net/parsers"
 xmlns:saxon="http://saxon.sf.net/"
 xmlns:wfs="http://www.opengis.net/wfs"
 xmlns:ows="http://www.opengis.net/ows"
 xmlns:ogc="http://www.opengis.net/ogc"
 xmlns:gml="http://www.opengis.net/gml"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:xi="http://www.w3.org/2001/XInclude"
 xmlns:sf="http://cite.opengeospatial.org/gmlsf">

   <ctl:test name="wfs:run-LockFeature-POST">
    <ctl:param name="wfs.GetCapabilities.document" />
    <ctl:param name="supports.atomic.trx" />
    <ctl:assertion>Run test group for LockFeature requests using the POST method</ctl:assertion>
    <ctl:code>
    
		<ctl:call-test name="wfs:LockFeature-expiry">
			<ctl:with-param name="CAPABILITIES" select="$wfs.GetCapabilities.document" />
		</ctl:call-test>
		<ctl:call-test name="wfs:LockFeature-some-features">
			<ctl:with-param name="CAPABILITIES" select="$wfs.GetCapabilities.document" />
		</ctl:call-test>
		<ctl:call-test name="wfs:LockFeature-all-features">
			<ctl:with-param name="CAPABILITIES" select="$wfs.GetCapabilities.document" />
		</ctl:call-test>
		<ctl:call-test name="wfs:LockFeature-identifiers-none">
			<ctl:with-param name="CAPABILITIES" select="$wfs.GetCapabilities.document" />
		</ctl:call-test>		
		<ctl:call-test name="wfs:LockFeature-invalid-request">
			<ctl:with-param name="CAPABILITIES" select="$wfs.GetCapabilities.document" />
		</ctl:call-test>
    
      <xsl:variable name="wfs.LockFeature.post.url">
        <xsl:value-of select="$wfs.GetCapabilities.document//ows:OperationsMetadata/ows:Operation[@name='LockFeature']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>
	  </xsl:variable>
      <xsl:variable name="wfs.Transaction.post.url">
        <xsl:value-of select="$wfs.GetCapabilities.document//ows:OperationsMetadata/ows:Operation[@name='Transaction']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>
	  </xsl:variable>
      <xsl:variable name="wfs.GetFeature.get.url">
        <xsl:value-of select="$wfs.GetCapabilities.document//ows:OperationsMetadata/ows:Operation[@name='GetFeature']/ows:DCP/ows:HTTP/ows:Get/@xlink:href"/>
	  </xsl:variable>
      <xsl:variable name="wfs.GetFeature.post.url">
        <xsl:value-of select="$wfs.GetCapabilities.document//ows:OperationsMetadata/ows:Operation[@name='GetFeature']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>
	  </xsl:variable>
      <ctl:message>Target endpoint is <xsl:value-of select="$wfs.LockFeature.post.url"/></ctl:message>

  <ctl:call-test name="wfs:wfs-1.1.0-LockFeature-tc1.1">
    <ctl:with-param name="wfs.LockFeature.post.url" select="$wfs.LockFeature.post.url"/>
    <ctl:with-param name="wfs.Transaction.post.url" select="$wfs.Transaction.post.url"/>
    <ctl:with-param name="wfs.GetFeature.get.url" select="$wfs.GetFeature.get.url"/>
    <ctl:with-param name="wfs.GetFeature.post.url" select="$wfs.GetFeature.post.url"/>
    <ctl:with-param name="supports.atomic.trx" select="$supports.atomic.trx"/>
  </ctl:call-test>
  <ctl:call-test name="wfs:wfs-1.1.0-LockFeature-tc2.1">
    <ctl:with-param name="wfs.Transaction.post.url" select="$wfs.Transaction.post.url"/>
  </ctl:call-test>
  <ctl:call-test name="wfs:wfs-1.1.0-LockFeature-tc3.1">
    <ctl:with-param name="wfs.LockFeature.post.url" select="$wfs.LockFeature.post.url"/>
    <ctl:with-param name="wfs.Transaction.post.url" select="$wfs.Transaction.post.url"/>
    <ctl:with-param name="wfs.GetFeature.get.url" select="$wfs.GetFeature.get.url"/>
    <ctl:with-param name="wfs.GetFeature.post.url" select="$wfs.GetFeature.post.url"/>
    <ctl:with-param name="supports.atomic.trx" select="$supports.atomic.trx"/>
  </ctl:call-test>

      </ctl:code>
    </ctl:test>

    <test name="wfs:wfs-1.1.0-LockFeature-tc1.1">
      <param name="wfs.LockFeature.post.url"/>
      <param name="wfs.Transaction.post.url"/>
      <param name="wfs.GetFeature.get.url"/>
      <param name="wfs.GetFeature.post.url"/>
      <ctl:param name="supports.atomic.trx" />
      <assertion>
      The response to a LockFeature request that specifies lockAction="ALL" must
      include a response that identifies all locked features. If any candidate
      features cannot be locked, then no feature shall be locked and an exception
      report is returned.
      </assertion>
      <comment>Pass if all validation steps pass. The following requests are submitted to the IUT:
      0. Insert sf:PrimitiveGeoFeature instance
      1. LockFeature (all sf:PrimitiveGeoFeature instances)
      2. Delete without LockId - should fail
      3. Delete with LockId and release all locks - should succeed
      </comment>
      <link>wfs-1.1.0-LockFeature-atc1</link>
		<code>
            <xsl:variable name="response0">
				<request>
					<url>
						<xsl:value-of select="$wfs.Transaction.post.url"/>
					</url>
                    <method>POST</method>
					<body>
                      <xi:include href="./wfs-1.1.0-LockFeature-tc1.1.0.body.xml"/>
					</body>
					<p:XMLValidatingParser.GMLSF1/>
				</request>
			</xsl:variable>
			<xsl:variable name="response">
				<request>
					<url>
						<xsl:value-of select="$wfs.LockFeature.post.url"/>
					</url>
                    <method>POST</method>
					<body>
                      <xi:include href="./wfs-1.1.0-LockFeature-tc1.1.1.body.xml"/>
					</body>
					<p:XMLValidatingParser.GMLSF1/>
				</request>
			</xsl:variable>

            <xsl:choose>
              <xsl:when test="not($response0/* or $response/*)">
                  <ctl:message>FAILURE: Missing or invalid response entity.</ctl:message>
                  <ctl:fail/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:variable name="LockId" select="$response//wfs:LockId" />
                <xsl:variable name="totalLocked" select="count($response//wfs:FeaturesLocked/*)" />
                <xsl:if test="$totalLocked lt 4">
                  <ctl:message>FAILURE: Expected 4 or more sf:PrimitiveGeoFeature instances to be locked (reported <xsl:value-of select="$totalLocked"/>)</ctl:message>
                  <ctl:fail/>
                </xsl:if>
                <xsl:variable name="fid">
                  <xsl:value-of select="$response//wfs:FeaturesLocked/ogc:FeatureId[1]/@fid"/>
                </xsl:variable>
                <!-- Submit delete request WITHOUT LockId -->
                <xsl:variable name="response2">
				  <request>
					<url>
						<xsl:value-of select="$wfs.Transaction.post.url"/>
					</url>
                    <method>POST</method>
					<body>
                      <xi:include href="./wfs-1.1.0-LockFeature-tc1.1.2.body.xml"/>
					</body>
                    <p:XMLValidatingParser.GMLSF1/>
				  </request>
			    </xsl:variable>
			    <xsl:choose>
					<xsl:when test="$supports.atomic.trx">
						<ctl:call-test name="ctl:SchematronValidatingParser">
							<ctl:with-param name="doc" select="$response2" />
							<ctl:with-param name="schema">sch/ows/1.0.0/ExceptionReport.sch</ctl:with-param>
							<ctl:with-param name="phase">MissingParameterValuePhase</ctl:with-param>
						</ctl:call-test>
					</xsl:when>
					<xsl:otherwise>
						<xsl:variable name="totalDeleted"><xsl:value-of select="$response2//wfs:totalDeleted"/></xsl:variable>
						<xsl:if test="$totalDeleted != 0">
						  <ctl:message>FAILURE: Expected totalDeleted = 0 (reported total is <xsl:value-of select="$totalDeleted"/>)</ctl:message>
						  <ctl:fail/>
						</xsl:if>		
						<xsl:if test="$response2//wfs:TransactionResults/wfs:Action/@locator != 'del-1'">
						  <ctl:message>FAILURE: Expected wfs:Action/@locator = 'del-1'</ctl:message>
						  <ctl:fail/>
						</xsl:if>										
					</xsl:otherwise>
			    </xsl:choose>   			    
                <ctl:call-test name="wfs:GetFeatureById-KVP">
                  <ctl:with-param name="wfs.GetFeature.get.url" select="$wfs.GetFeature.get.url"/>
                  <ctl:with-param name="id" select="$fid"/>
                  <ctl:with-param name="empty.response" select="'false'" />
                </ctl:call-test>
                <!-- Submit delete request WITH LockId and release ALL locks -->
                <xsl:variable name="response3">
				  <request>
					<url>
						<xsl:value-of select="$wfs.Transaction.post.url"/>
					</url>
                    <method>POST</method>
					<body>
                       <xi:include href="./wfs-1.1.0-LockFeature-tc1.1.3.body.xml"/>
					</body>
                    <p:XMLValidatingParser.GMLSF1/>
				  </request>
			    </xsl:variable>
                <xsl:variable name="totalDeleted"><xsl:value-of select="$response3//wfs:totalDeleted"/></xsl:variable>
                <xsl:if test="$totalDeleted != 1">
                  <ctl:message>FAILURE: Expected totalDeleted = 1 (reported total is <xsl:value-of select="$totalDeleted"/>)</ctl:message>
                  <ctl:fail/>
                </xsl:if>
                <ctl:call-test name="wfs:GetFeatureByName">
                  <ctl:with-param name="wfs.GetFeature.post.url" select="$wfs.GetFeature.post.url"/>
                  <ctl:with-param name="type" select="'sf:PrimitiveGeoFeature'"/>
                  <ctl:with-param name="name.value" select="'cite.gmlsf0-f501'" />
                  <ctl:with-param name="empty.response" select="'true'" />
                </ctl:call-test>
              </xsl:otherwise>
            </xsl:choose>
		</code>
	</test>

    <test name="wfs:wfs-1.1.0-LockFeature-tc2.1">
      <param name="wfs.Transaction.post.url"/>
      <assertion>
      The response to a Transaction request that specifies an invalid LockId
      value must include an exception report.
      </assertion>
      <comment>Pass if all of the following conditions are true: (1) the response
      is a valid ows:ExceptionReport; (2) the reported exceptionCode is "InvalidParameterValuePhase".
      </comment>
      <link>wfs-1.1.0-LockFeature-atc2</link>
		<code>
			<xsl:variable name="response">
				<request>
					<url>
						<xsl:value-of select="$wfs.Transaction.post.url"/>
					</url>
                    <method>POST</method>
					<body>
                       <xi:include href="./wfs-1.1.0-LockFeature-tc2.1.body.xml"/>
					</body>
					<p:XMLValidatingParser.OWS />
				</request>
			</xsl:variable>

            <xsl:choose>
              <xsl:when test="not($response/*)">
                  <ctl:message>FAILURE: Missing response entity.</ctl:message>
                  <ctl:fail/>
              </xsl:when>
              <xsl:otherwise>
                <ctl:call-test name="ctl:SchematronValidatingParser">
		            <ctl:with-param name="doc" select="$response" />
		            <ctl:with-param name="schema">sch/ows/1.0.0/ExceptionReport.sch</ctl:with-param>
		            <ctl:with-param name="phase">InvalidParameterValuePhase</ctl:with-param>
	            </ctl:call-test>
              </xsl:otherwise>
            </xsl:choose>
		</code>
	</test>

    <test name="wfs:wfs-1.1.0-LockFeature-tc3.1">
      <param name="wfs.LockFeature.post.url"/>
      <param name="wfs.Transaction.post.url"/>
      <param name="wfs.GetFeature.get.url"/>
      <param name="wfs.GetFeature.post.url"/>
      <ctl:param name="supports.atomic.trx" />
      <assertion>
      In response to a Transaction request that specifies releaseAction="SOME",
      only modified features in the lock set shall be unlocked.
      </assertion>
      <comment>Pass if all validation steps pass. The following requests are submitted to the IUT:
      0. Insert sf:EntitéGénérique feature instance
      1. LockFeature (sf:EntitéGénérique instances by BBOX)
      2. Update with LockId and releaseAction="SOME" - should succeed and unlock modified feature
      3. Delete unlocked feature without LockId - should succeed
      4. Delete locked feature without LockId - should fail</comment>
      <link>wfs-1.1.0-LockFeature-atc3</link>
		<code>
            <xsl:variable name="response0">
				<request>
					<url>
						<xsl:value-of select="$wfs.Transaction.post.url"/>
					</url>
                    <method>POST</method>
					<body>
                      <xi:include href="./wfs-1.1.0-LockFeature-tc3.1.0.body.xml"/>
					</body>
					<p:XMLValidatingParser.GMLSF1/>
				</request>
			</xsl:variable>
			<xsl:variable name="response">
				<request>
					<url>
						<xsl:value-of select="$wfs.LockFeature.post.url"/>
					</url>
                    <method>POST</method>
					<body>
                       <xi:include href="./wfs-1.1.0-LockFeature-tc3.1.1.body.xml"/>
					</body>
					<p:XMLValidatingParser.GMLSF1/>
				</request>
			</xsl:variable>

            <xsl:choose>
              <xsl:when test="not($response0/* or $response/*)">
                  <ctl:message>FAILURE: Missing response entity.</ctl:message>
                  <ctl:fail/>
              </xsl:when>
              <xsl:otherwise>
                <xsl:variable name="LockId" select="$response//wfs:LockId" />
                <xsl:variable name="totalLocked" select="count($response//wfs:FeaturesLocked/*)" />
                <xsl:if test="$totalLocked lt 2">
                  <ctl:message>FAILURE: Expected 2 or more sf:EntitéGénérique instances to be locked (reported <xsl:value-of select="$totalLocked"/>)</ctl:message>
                  <ctl:fail/>
                </xsl:if>
                <!-- Submit update request with releaseAction = SOME -->
                <xsl:variable name="response2">
				  <request>
					<url>
						<xsl:value-of select="$wfs.Transaction.post.url"/>
					</url>
                    <method>POST</method>
					<body>
                       <xi:include href="./wfs-1.1.0-LockFeature-tc3.1.2.body.xml"/>
					</body>
                    <p:XMLValidatingParser.GMLSF1/>
				  </request>
			    </xsl:variable>
                <xsl:variable name="totalUpdated"><xsl:value-of select="$response2//wfs:totalUpdated"/></xsl:variable>
                <xsl:if test="$totalUpdated != 1">
                  <ctl:message>FAILURE: Expected totalUpdated = 1 (reported total is <xsl:value-of select="$totalUpdated"/>)</ctl:message>
                  <ctl:fail/>
                </xsl:if>
                <!-- Previously updated feature should now be UNLOCKED -->
                <xsl:variable name="response3">
				  <request>
					<url>
						<xsl:value-of select="$wfs.Transaction.post.url"/>
					</url>
                    <method>POST</method>
					<body>
                       <xi:include href="./wfs-1.1.0-LockFeature-tc3.1.3.body.xml"/>
					</body>
                    <p:XMLValidatingParser.GMLSF1/>
				  </request>
			    </xsl:variable>
                <xsl:variable name="totalDeleted"><xsl:value-of select="$response3//wfs:totalDeleted"/></xsl:variable>
                <xsl:if test="$totalDeleted != 1">
                  <ctl:message>FAILURE: Expected totalDeleted = 1 (feature with gml:name="cite.gmlsf0-f502" should be UNLOCKED)</ctl:message>
                  <ctl:fail/>
                </xsl:if>
                <ctl:call-test name="wfs:GetFeatureByName">
                  <ctl:with-param name="wfs.GetFeature.post.url" select="$wfs.GetFeature.post.url"/>
                  <ctl:with-param name="type" select="'sf:EntitéGénérique'"/>
                  <ctl:with-param name="name.value" select="'cite.gmlsf0-f502'" />
                  <ctl:with-param name="empty.response" select="'true'" />
                </ctl:call-test>
                <!-- Unmodified features should remain LOCKED -->
                <xsl:variable name="response4">
				  <request>
					<url>
						<xsl:value-of select="$wfs.Transaction.post.url"/>
					</url>
                    <method>POST</method>
					<body>
                       <xi:include href="./wfs-1.1.0-LockFeature-tc3.1.4.body.xml"/>
					</body>
                    <p:XMLValidatingParser.GMLSF1/>
				  </request>
			    </xsl:variable>
			    <xsl:choose>
					<xsl:when test="$supports.atomic.trx">
						<ctl:call-test name="ctl:SchematronValidatingParser">
							<ctl:with-param name="doc" select="$response4" />
							<ctl:with-param name="schema">sch/ows/1.0.0/ExceptionReport.sch</ctl:with-param>
							<ctl:with-param name="phase">DefaultPhase</ctl:with-param>
						</ctl:call-test>
					</xsl:when>
					<xsl:otherwise>
						<xsl:variable name="totalDeleted"><xsl:value-of select="$response4//wfs:totalDeleted"/></xsl:variable>
						<xsl:if test="$totalDeleted != 0">
						  <ctl:message>FAILURE: Expected totalDeleted = 0 (reported total is <xsl:value-of select="$totalDeleted"/>)</ctl:message>
						  <ctl:fail/>
						</xsl:if>		
						<xsl:if test="$response4//wfs:TransactionResults/wfs:Action/@locator != 'del-1'">
						  <ctl:message>FAILURE: Expected wfs:Action/@locator = 'del-1'</ctl:message>
						  <ctl:fail/>
						</xsl:if>										
					</xsl:otherwise>
			    </xsl:choose>  
              </xsl:otherwise>
            </xsl:choose>
		</code>
	</test>
	
		<ctl:test name="wfs:LockFeature-expiry">
		<ctl:param name="CAPABILITIES" />
		<ctl:assertion>After a LockFeature request with an expiry attribute is submitted and the time expires, the lock is released.</ctl:assertion>
		<ctl:comment></ctl:comment>				
      	<ctl:link>OGC 04-094, 11.2.1, p.56</ctl:link>
      	<ctl:link>OGC 04-094, 11.2.1, p.56</ctl:link>
		<ctl:code>		
			<xsl:choose>
	            <xsl:when test="not($CAPABILITIES/wfs:FeatureTypeList/wfs:FeatureType[wfs:Name='sf:PrimitiveGeoFeature'])">
					<ctl:message>sf:PrimitiveGeoFeature does not exist</ctl:message>		        	
	            </xsl:when>
	            <xsl:otherwise>
					<xsl:variable name="LCK1-RESPONSE">
						<ctl:request>
							<ctl:url>
								<xsl:value-of select="$CAPABILITIES/ows:OperationsMetadata/ows:Operation[@name='LockFeature']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>			
							</ctl:url>
		                    <method>POST</method>
							<body>					
							<wfs:LockFeature service="WFS" version="1.1.0" 
							  expiry="1"
							  lockAction="ALL"
							  xmlns:wfs="http://www.opengis.net/wfs" 
							  xmlns:gml="http://www.opengis.net/gml" 
							  xmlns:ogc="http://www.opengis.net/ogc"
							  xmlns:sf="http://cite.opengeospatial.org/gmlsf">					  
							  <wfs:Lock typeName="sf:PrimitiveGeoFeature" >
								  <ogc:Filter>
									<ogc:GmlObjectId gml:id="PrimitiveGeoFeature.8"/>
								  </ogc:Filter>
							  </wfs:Lock>
							</wfs:LockFeature>
							</body>
				            <parsers:HTTPParser>
				               <parsers:parse>
				                  <parsers:HTTPParser/>
				               </parsers:parse>
				            </parsers:HTTPParser>
						</ctl:request>
					</xsl:variable>	
					<xsl:choose>
						<xsl:when test="$LCK1-RESPONSE//wfs:FeaturesLocked/ogc:FeatureId[1]/@fid='PrimitiveGeoFeature.8'">
							<ctl:call-function name="wfs:sleep">
							  <ctl:with-param name="milliseconds">100000</ctl:with-param>
							</ctl:call-function>
							<xsl:variable name="LCK2-RESPONSE">
								<ctl:request>
									<ctl:url>
										<xsl:value-of select="$CAPABILITIES/ows:OperationsMetadata/ows:Operation[@name='LockFeature']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>			
									</ctl:url>
				                    <method>POST</method>
									<body>					
									<wfs:LockFeature service="WFS" version="1.1.0" 
									  expiry="1"
									  lockAction="SOME"
									  xmlns:wfs="http://www.opengis.net/wfs" 
									  xmlns:gml="http://www.opengis.net/gml" 
									  xmlns:ogc="http://www.opengis.net/ogc"
									  xmlns:sf="http://cite.opengeospatial.org/gmlsf">					  
									  <wfs:Lock typeName="sf:PrimitiveGeoFeature" >
										  <ogc:Filter>
											<ogc:GmlObjectId gml:id="PrimitiveGeoFeature.8"/>
										  </ogc:Filter>
									  </wfs:Lock>
									</wfs:LockFeature>
									</body>
						            <parsers:HTTPParser>
						               <parsers:parse>
						                  <parsers:HTTPParser/>
						               </parsers:parse>
						            </parsers:HTTPParser>
								</ctl:request>
							</xsl:variable>								
							<xsl:if test="not($LCK2-RESPONSE//wfs:FeaturesLocked/ogc:FeatureId[1]/@fid='PrimitiveGeoFeature.8')">
								<ctl:fail/>
							</xsl:if>
							<!-- Release Lock -->
							<xsl:variable name="LOCKID">
								<xsl:value-of select="$LCK2-RESPONSE//wfs:LockFeatureResponse/wfs:LockId"/>			
							</xsl:variable>
							<xsl:variable name="TXN-RESPONSE">
								<ctl:request>
									<ctl:url>
										<xsl:value-of select="$CAPABILITIES/ows:OperationsMetadata/ows:Operation[@name='Transaction']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>			
									</ctl:url>
				                    <method>POST</method>
									<body>					
									<wfs:Transaction service="WFS" version="1.1.0"
										  xmlns:wfs="http://www.opengis.net/wfs"
										  xmlns:gml="http://www.opengis.net/gml"
										  xmlns:ogc="http://www.opengis.net/ogc"
										  xmlns:sf="http://cite.opengeospatial.org/gmlsf"
										  releaseAction="ALL" >					
										<wfs:LockID><xsl:value-of select="$LOCKID"/></wfs:LockID>
									</wfs:Transaction>
									</body>
						            <parsers:HTTPParser>
						               <parsers:parse>
						                  <parsers:HTTPParser/>
						               </parsers:parse>
						            </parsers:HTTPParser>
								</ctl:request>
							</xsl:variable>																						
						</xsl:when>
						<xsl:otherwise>
							<ctl:message>Unable to acquire lock on PrimitiveGeoFeature.8</ctl:message>		        								
						</xsl:otherwise>							
			        </xsl:choose>	            
				</xsl:otherwise>
			</xsl:choose>		
		
		</ctl:code>
	</ctl:test>

	<ctl:test name="wfs:LockFeature-some-features">
		<ctl:param name="CAPABILITIES" />
		<ctl:assertion>In response to a LockFeature request that includes some locked and some unlocked feature identifiers and lockAction=SOME, the response is a 'WFS_LockFeatureResponse' element that lists the previously unlocked feature ids in the 'FeaturesLocked' element and the previously locked feature ids in the 'FeaturesNotLocked' element.  The previously unlocked features are locked.</ctl:assertion>
		<ctl:comment>"If the lock action is set to SOME, then a web feature service shall attempt to lock as many of the requested feature instances as it can." 
					"If the lock action is specified as SOME, then the 'WFS_LockFeatureResponse' element must contain the 'FeaturesLocked' and 'FeaturesNotLocked' elements."
					"The 'FeaturesLocked' element shall list the feature identifiers of all the feature instances that were locked by the LockFeature request."
					"The 'FeaturesNotLocked' element shall contain a list of feature identifiers for the feature instances that could not be locked by the web feature service (possibly because they were already locked by someone else)."</ctl:comment>				
      	<ctl:link>OGC 04-094, 11.2.1, p.57</ctl:link>
      	<ctl:link>OGC 04-094, 11.3, p.59</ctl:link>
      	<ctl:link>OGC 04-094, 11.3, p.59</ctl:link>
      	<ctl:link>OGC 04-094, 11.3, p.59</ctl:link>
		<ctl:code>		
			<xsl:choose>
	            <xsl:when test="not($CAPABILITIES/wfs:FeatureTypeList/wfs:FeatureType[wfs:Name='sf:PrimitiveGeoFeature'])">
					<ctl:message>sf:PrimitiveGeoFeature does not exist</ctl:message>		        	
	            </xsl:when>
	            <xsl:otherwise>
					<xsl:variable name="LCK1-RESPONSE">
						<ctl:request>
							<ctl:url>
								<xsl:value-of select="$CAPABILITIES/ows:OperationsMetadata/ows:Operation[@name='LockFeature']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>			
							</ctl:url>
		                    <method>POST</method>
							<body>					
							<wfs:LockFeature service="WFS" version="1.1.0" 
							  expiry="1"
							  lockAction="ALL"
							  xmlns:wfs="http://www.opengis.net/wfs" 
							  xmlns:gml="http://www.opengis.net/gml" 
							  xmlns:ogc="http://www.opengis.net/ogc"
							  xmlns:sf="http://cite.opengeospatial.org/gmlsf">					  
							  <wfs:Lock typeName="sf:PrimitiveGeoFeature" >
								  <ogc:Filter>
									<ogc:GmlObjectId gml:id="PrimitiveGeoFeature.3"/>
								  </ogc:Filter>
							  </wfs:Lock>
							</wfs:LockFeature>
							</body>
				            <parsers:HTTPParser>
				               <parsers:parse>
				                  <parsers:HTTPParser/>
				               </parsers:parse>
				            </parsers:HTTPParser>
						</ctl:request>
					</xsl:variable>	
					
					<xsl:choose>
						<xsl:when test="$LCK1-RESPONSE//wfs:FeaturesLocked/ogc:FeatureId[1]/@fid='PrimitiveGeoFeature.3'">							
							<xsl:variable name="LCK2-RESPONSE">
								<ctl:request>
									<ctl:url>
										<xsl:value-of select="$CAPABILITIES/ows:OperationsMetadata/ows:Operation[@name='LockFeature']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>			
									</ctl:url>
				                    <method>POST</method>
									<body>					
									<wfs:LockFeature service="WFS" version="1.1.0" 
									  expiry="1"
									  lockAction="SOME"
									  xmlns:wfs="http://www.opengis.net/wfs" 
									  xmlns:gml="http://www.opengis.net/gml" 
									  xmlns:ogc="http://www.opengis.net/ogc"
									  xmlns:sf="http://cite.opengeospatial.org/gmlsf">					  
									  <wfs:Lock typeName="sf:PrimitiveGeoFeature" >
										  <ogc:Filter>
											<ogc:GmlObjectId gml:id="PrimitiveGeoFeature.1"/>
											<ogc:GmlObjectId gml:id="PrimitiveGeoFeature.2"/>
											<ogc:GmlObjectId gml:id="PrimitiveGeoFeature.3"/>
										  </ogc:Filter>
									  </wfs:Lock>
									</wfs:LockFeature>
									</body>
						            <parsers:HTTPParser>
						               <parsers:parse>
						                  <parsers:HTTPParser/>
						               </parsers:parse>
						            </parsers:HTTPParser>
								</ctl:request>
							</xsl:variable>	

							<xsl:if test="not($LCK2-RESPONSE//wfs:FeaturesLocked/ogc:FeatureId/@fid='PrimitiveGeoFeature.1' and $LCK2-RESPONSE//wfs:FeaturesLocked/ogc:FeatureId/@fid='PrimitiveGeoFeature.2' and $LCK2-RESPONSE//wfs:FeaturesNotLocked/ogc:FeatureId/@fid='PrimitiveGeoFeature.3')">
								<ctl:fail/>
							</xsl:if>
							<!-- Release lock -->
							<xsl:variable name="LOCKID">
								<xsl:value-of select="$LCK2-RESPONSE//wfs:LockFeatureResponse/wfs:LockId"/>			
							</xsl:variable>
							<xsl:variable name="TXN-RESPONSE">
								<ctl:request>
									<ctl:url>
										<xsl:value-of select="$CAPABILITIES/ows:OperationsMetadata/ows:Operation[@name='Transaction']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>			
									</ctl:url>
				                    <method>POST</method>
									<body>					
									<wfs:Transaction service="WFS" version="1.1.0"
										  xmlns:wfs="http://www.opengis.net/wfs"
										  xmlns:gml="http://www.opengis.net/gml"
										  xmlns:ogc="http://www.opengis.net/ogc"
										  xmlns:sf="http://cite.opengeospatial.org/gmlsf"
										  releaseAction="ALL" >					
										<wfs:LockID><xsl:value-of select="$LOCKID"/></wfs:LockID>
									</wfs:Transaction>
									</body>
						            <parsers:HTTPParser>
						               <parsers:parse>
						                  <parsers:HTTPParser/>
						               </parsers:parse>
						            </parsers:HTTPParser>
								</ctl:request>
							</xsl:variable>															
						</xsl:when>
						<xsl:otherwise>
							<ctl:message>Unable to acquire lock on PrimitiveGeoFeature.3</ctl:message>		        								
						</xsl:otherwise>							
			        </xsl:choose>	            
				</xsl:otherwise>
			</xsl:choose>		
		</ctl:code>
	</ctl:test>


	<ctl:test name="wfs:LockFeature-all-features">
		<ctl:param name="CAPABILITIES" />
		<ctl:assertion>The response to a LockFeature request includes the identifiers of features that were locked.</ctl:assertion>
		<ctl:comment></ctl:comment>				
      	<ctl:link>OGC 04-094, 11.3, p.59</ctl:link>
		<ctl:code>
			<xsl:choose>
	            <xsl:when test="not($CAPABILITIES/wfs:FeatureTypeList/wfs:FeatureType[wfs:Name='sf:AggregateGeoFeature'])">
					<ctl:message>sf:AggregateGeoFeature does not exist</ctl:message>		        	
	            </xsl:when>
	            <xsl:otherwise>
					<xsl:variable name="LCK-RESPONSE">
						<ctl:request>
							<ctl:url>
								<xsl:value-of select="$CAPABILITIES/ows:OperationsMetadata/ows:Operation[@name='LockFeature']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>			
							</ctl:url>
		                    <method>POST</method>
							<body>					
							<wfs:LockFeature service="WFS" version="1.1.0" 
							  expiry="1"
							  lockAction="ALL"
							  xmlns:wfs="http://www.opengis.net/wfs" 
							  xmlns:gml="http://www.opengis.net/gml" 
							  xmlns:sf="http://cite.opengeospatial.org/gmlsf">					  
							  <wfs:Lock typeName="sf:AggregateGeoFeature" >
							  </wfs:Lock>
							</wfs:LockFeature>
							</body>
				            <parsers:HTTPParser>
				               <parsers:parse>
				                  <parsers:HTTPParser/>
				               </parsers:parse>
				            </parsers:HTTPParser>
						</ctl:request>
					</xsl:variable>	
					
					<xsl:if test="not($LCK-RESPONSE//wfs:FeaturesLocked/*)">
						<ctl:fail/>
					</xsl:if>
					<!-- Release lock -->
					<xsl:variable name="LOCKID">
						<xsl:value-of select="$LCK-RESPONSE//wfs:LockFeatureResponse/wfs:LockId"/>			
					</xsl:variable>
					<xsl:variable name="TXN-RESPONSE">
						<ctl:request>
							<ctl:url>
								<xsl:value-of select="$CAPABILITIES/ows:OperationsMetadata/ows:Operation[@name='Transaction']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>			
							</ctl:url>
		                    <method>POST</method>
							<body>					
							<wfs:Transaction service="WFS" version="1.1.0"
								  xmlns:wfs="http://www.opengis.net/wfs"
								  xmlns:gml="http://www.opengis.net/gml"
								  xmlns:ogc="http://www.opengis.net/ogc"
								  xmlns:sf="http://cite.opengeospatial.org/gmlsf"
								  releaseAction="ALL" >					
								<wfs:LockID><xsl:value-of select="$LOCKID"/></wfs:LockID>
							</wfs:Transaction>
							</body>
				            <parsers:HTTPParser>
				               <parsers:parse>
				                  <parsers:HTTPParser/>
				               </parsers:parse>
				            </parsers:HTTPParser>
						</ctl:request>
					</xsl:variable>															
				</xsl:otherwise>							
	        </xsl:choose>	            
		</ctl:code>
	</ctl:test>


	<ctl:test name="wfs:LockFeature-identifiers-none">
		<ctl:param name="CAPABILITIES" />
		<ctl:assertion>In response to a LockFeature request that contains a filter that doesn't match any features, the response is a 'WFS_LockFeatureResponse' document that contains a value for the lockId attribute but contains neither a 'FeaturesLocked' element nor a 'FeatureNotLocked' element.</ctl:assertion>
		<ctl:comment></ctl:comment>				
      	<ctl:link>OGC 04-094, 11.3, p.59</ctl:link>
		<ctl:code>
			<xsl:variable name="RESPONSE">
				<ctl:request>
					<ctl:url>
						<xsl:value-of select="$CAPABILITIES/ows:OperationsMetadata/ows:Operation[@name='LockFeature']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>			
					</ctl:url>
                    <method>POST</method>
					<body>					
					<wfs:LockFeature service="WFS" version="1.1.0" 
					  expiry="1"
					  lockAction="ALL"
					  xmlns:wfs="http://www.opengis.net/wfs" 
					  xmlns:gml="http://www.opengis.net/gml" 
					  xmlns:sf="http://cite.opengeospatial.org/gmlsf">					  
					  <wfs:Lock typeName="sf:PrimitiveGeoFeature" >
						  <ogc:Filter>
							<ogc:GmlObjectId gml:id="PrimitiveGeoFeature.00"/>
						  </ogc:Filter>
					  </wfs:Lock>
					</wfs:LockFeature>
					</body>
		            <parsers:HTTPParser>
		               <parsers:parse>
		                  <parsers:HTTPParser/>
		               </parsers:parse>
		            </parsers:HTTPParser>
				</ctl:request>
			</xsl:variable>			
			<xsl:if test="$RESPONSE//wfs:LockFeatureResponse/wfs:FeaturesLocked">
				<ctl:fail/>
			</xsl:if>
		</ctl:code>
	</ctl:test>
	
	<ctl:test name="wfs:LockFeature-invalid-request">
		<ctl:param name="CAPABILITIES" />
		<ctl:assertion>An invalid LockFeature request results in an exception.</ctl:assertion>
		<ctl:comment></ctl:comment>				
      	<ctl:link>OGC 04-094, 11.4, p.60</ctl:link>
		<ctl:code>
			<xsl:variable name="RESPONSE">
				<ctl:request>
					<ctl:url>
						<xsl:value-of select="$CAPABILITIES/ows:OperationsMetadata/ows:Operation[@name='LockFeature']/ows:DCP/ows:HTTP/ows:Post/@xlink:href"/>			
					</ctl:url>
					<ctl:method>get</ctl:method>
					<ctl:param name="request">LockFeature</ctl:param>					
					<ctl:param name="service">WFS</ctl:param>
					<ctl:param name="version">1.1.0</ctl:param>
					<ctl:param name="Lock">Invalid</ctl:param>
					<param name="typename">
						<xsl:value-of select="wfs:encode($CAPABILITIES/wfs:FeatureTypeList/wfs:FeatureType[1]/wfs:Name)"/>			
					</param>
		            <parsers:HTTPParser>
		               <parsers:parse>
		                  <parsers:HTTPParser/>
		               </parsers:parse>
		            </parsers:HTTPParser>
				</ctl:request>
			</xsl:variable>	
			<xsl:if test="not($RESPONSE//ows:Exception/*)">
				<ctl:fail/>
			</xsl:if>
		</ctl:code>
	</ctl:test>
	
</ctl:package>
