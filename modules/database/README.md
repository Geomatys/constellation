## Database modules

#### cstl-database-model
Contain database model and migration scripts used by Flywaydb.

#### cstl-database-api
Contain repositories interfaces and Pojo/Dao generated by JOOQ.
To rebuild JOOQ models, build module with `-Pgenerate` build option.

#### cstl-database-impl
Contain repositories implementations.

#### cstl-database-configuration
Contain Database access and initialization configuration beans and Spring context files.

## Constellation Model

### How to create a migration patch for Constellation database
Constellation use [Flyway](http://flywaydb.org/) to maintain and upgrade database model.

Adding a patch for database can be done through two way :
* plain **SQL** script
* or from **Java** script

#### SQL patches
SQL patches should be stored in resources folder **org/constellation/database/model/migration** of `cstl-database-model` module.
These patches should be named with pattern describe [here](#patch-name-pattern).

#### JAVA patches
Java patches should be stored in source package **org.constellation.database.model.migration** of `cstl-database-model` module. Like SQL patches, Java classes should be named with a specific [pattern](#patch-name-pattern), but dots should be replaced by underscores.

#### Patch name pattern
Patch names are composed of 4 parts :
* **prefix**: patch prefix, by default **V**
* **version**: Dots or underscores separate the parts
* **separator**: By default: __ (two underscores)
* **description**: patch description

Example : **V1.1.0_1__init**

Here, version is **1.1.0_1** and description is **init**

Version number is composed in two parts, **1.1.0** and **_1**.
The first 3 numbers (**1.1.0**) correspond to Constellation version where the patch appeared.
The last number (**1**) is separated with an underscore and is incremented each time a new patch with the same version is created.

For example in order :
* **1.1.0_1**
* **1.1.0_2**
* **1.1.0_3**
* **1.1.1_1**
* **1.1.5_1**
* **1.1.5_2**
* ... and so on

#### No-linear development
In case of no-linear development, database patch will be created inside feature branch. In this case, we will not sure when
feature branch will be merged, so patch name can't be known.

To fix that, feature branch must contain patch containing creation timestamp as version and rename with final version when request is merged.

To create a temporary patch, juste run `createEmptyPatch.sh` script that will create an SQL patch
named with pattern `T<timestamp>__desc.sql` in migration folder.

### How to update JOOQ POJO/DAO matching model changes
After updating database model (with migration patches), we need to rebuild Java POJO/DAO generated by JOOQ to match changes.

But because JOOQ is generated from a PostgreSQL database. So before running generation,
an empty database matching JDBC configuration is needed.

Default configuration is defined in `cstl-database-api` pom file.

```xml
<properties>
    <jdbc.url>jdbc:postgresql://localhost:5432/cstl-test</jdbc.url>
    <jdbc.user>cstl</jdbc.user>
    <jdbc.passwd>admin</jdbc.passwd>
</properties>
```

After database is created, we can build Constellation with `generate` profile:

```bash
cd ./modules/database/
mvn clean install -Pgenerate
```