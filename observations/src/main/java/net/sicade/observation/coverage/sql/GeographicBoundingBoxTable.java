/*
 * Sicade - Systèmes intégrés de connaissances pour l'aide à la décision en environnement
 * (C) 2006, Institut de Recherche pour le Développement
 *
 *    This library is free software; you can redistribute it and/or
 *    modify it under the terms of the GNU Lesser General Public
 *    License as published by the Free Software Foundation; either
 *    version 2.1 of the License, or (at your option) any later version.
 *
 *    This library is distributed in the hope that it will be useful,
 *    but WITHOUT ANY WARRANTY; without even the implied warranty of
 *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 *    Lesser General Public License for more details.
 *
 *    You should have received a copy of the GNU Lesser General Public
 *    License along with this library; if not, write to the Free Software
 *    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */
package net.sicade.observation.coverage.sql;

// J2SE dependencies
import java.awt.Dimension;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.PreparedStatement;
import java.util.logging.Level;
import java.util.logging.LogRecord;

// OpenGIS dependencies
import org.opengis.metadata.extent.GeographicBoundingBox;

// Seagis
import net.sicade.observation.Element;
import net.sicade.observation.ConfigurationKey;
import net.sicade.observation.CatalogException;
import net.sicade.observation.sql.Table;
import net.sicade.observation.sql.Database;
import net.sicade.observation.sql.Shareable;
import net.sicade.resources.seagis.Resources;
import net.sicade.resources.seagis.ResourceKeys;


/**
 * Connexion à la table des étendues géographiques des images.
 *
 * @version $Id$
 * @author Martin Desruisseaux
 * @author Antoine Hnawia
 */
public class GeographicBoundingBoxTable extends Table implements Shareable {
    /**
     * Facteur de tolérance pour la comparaison des limites géographiques.
     */
    private static final double EPSILON = 1E-7;
    
    /**
     * The SQL instruction to use when looking for bounding box. Note that an "INSERT"
     * instruction may be generated by the {@link #addGeographicBoundingBox} method.
     */
    private static final ConfigurationKey SELECT = new ConfigurationKey("GeographicBoundingBoxes:SELECT",
            "SELECT id FROM \"GeographicBoundingBoxes\"\n"          +
            " WHERE ABS(\"westBoundLongitude\" - ?) <= " + EPSILON  + '\n' +
            "   AND ABS(\"eastBoundLongitude\" - ?) <= " + EPSILON  + '\n' +
            "   AND ABS(\"southBoundLatitude\" - ?) <= " + EPSILON  + '\n' +
            "   AND ABS(\"northBoundLatitude\" - ?) <= " + EPSILON  + '\n' +
            "   AND width=? AND height=?");

    /**
     * The SQL instruction for inserting a new geographic bounding box.
     */
    private static final ConfigurationKey INSERT = new ConfigurationKey("GeographicBoundingBoxes:INSERT",
            "INSERT INTO coverages.\"GeographicBoundingBoxes\"\n"+
            "  (id, \"westBoundLongitude\",\n" +
            "       \"eastBoundLongitude\",\n" +
            "       \"southBoundLatitude\",\n" +
            "       \"northBoundLatitude\",\n" +
            "       width, height)\n"          +
            "  VALUES (?, ?, ?, ?, ?, ?, ?)");

    /**
     * Constructs a new {@code GeographicBoundingBoxTable}.
     *
     * @param  connection The connection to the database.
     * @throws SQLException if the table can't be constructed.
     */
    public GeographicBoundingBoxTable(final Database database) throws SQLException {
        super(database);
    }

    /**
     * Retourne l'identifieur de l'étendue géographique et la dimension d'image spécifiées.
     * Si aucun enregistrement n'a été trouvée, alors cette méthode retourne {@code null}.
     *
     * @param  bbox The geographic bounding box.
     * @param  size The image size, in pixels.
     * @throws SQLException if the operation failed.
     */
    public synchronized String getIdentifier(final GeographicBoundingBox bbox, final Dimension size)
            throws SQLException
    {
        final PreparedStatement statement = getStatement(getProperty(SELECT));
        statement.setDouble(1, bbox.getWestBoundLongitude());
        statement.setDouble(2, bbox.getEastBoundLongitude());
        statement.setDouble(3, bbox.getSouthBoundLatitude());
        statement.setDouble(4, bbox.getNorthBoundLatitude());
        statement.setInt   (5, size.width);
        statement.setInt   (6, size.height);
        String ID = null;
        final ResultSet result = statement.executeQuery();
        while (result.next()) {
            final String nextID = result.getString(1);
            if (ID!=null && !ID.equals(nextID)) {
                final LogRecord record = Resources.getResources(database.getLocale()).
                        getLogRecord(Level.WARNING, ResourceKeys.ERROR_DUPLICATED_GEOMETRY_$1, nextID);
                record.setSourceClassName("GeographicBoundingBoxTable");
                record.setSourceMethodName("getIdentifier");
                Element.LOGGER.log(record);
            } else {
                ID = nextID;
            }
        }
        result.close();
        return ID;
    }

    /**
     * Ajoute une entrée pour l'étendue géographique et la dimension d'image spécifiée.
     */
    public synchronized void addEntry(final String          identifier,
                                      final GeographicBoundingBox bbox,
                                      final Dimension             size)
            throws CatalogException, SQLException
    {
        final PreparedStatement statement = getStatement(getProperty(INSERT));
        statement.setString(1, identifier);
        statement.setDouble(2, bbox.getWestBoundLongitude());
        statement.setDouble(3, bbox.getEastBoundLongitude());
        statement.setDouble(4, bbox.getSouthBoundLatitude());
        statement.setDouble(5, bbox.getNorthBoundLatitude());
        statement.setInt   (6, size.width);
        statement.setInt   (7, size.height);
        if (statement.executeUpdate() != 1) {
            throw new CatalogException("L'étendue géographique n'a pas été ajoutée.");
        }
    }
}
